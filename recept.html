<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Recept Configurator</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #1f2942;
            --accent: #e94560;
            --accent-hover: #ff6b6b;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --success: #4ade80;
            --border-radius: 16px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
            padding-bottom: 100px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        header h1 { font-size: 1.8rem; margin-bottom: 8px; }
        header p { color: var(--text-secondary); font-size: 0.95rem; }
        .card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .card h2 { font-size: 1.1rem; margin-bottom: 16px; }
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px; }
        input[type="text"], input[type="password"], input[type="url"] {
            width: 100%; padding: 14px 16px; border: 2px solid transparent;
            border-radius: 12px; background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease;
        }
        input:focus { outline: none; border-color: var(--accent); background: rgba(255, 255, 255, 0.15); }
        input::placeholder { color: var(--text-secondary); }
        .btn {
            width: 100%; padding: 16px 24px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; display: flex; align-items: center;
            justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); }
        .btn-primary:disabled { background: #555; cursor: not-allowed; transform: none; }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: var(--text-primary); margin-top: 10px; }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.2); }
        .btn-success { background: var(--success); color: #1a1a2e; }
        .btn-success:hover { background: #22c55e; }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .tab {
            flex: 1; padding: 12px; border: none; border-radius: 10px;
            background: rgba(255, 255, 255, 0.1); color: var(--text-secondary);
            font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease;
        }
        .tab.active { background: var(--accent); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .file-upload {
            border: 2px dashed rgba(255, 255, 255, 0.3); border-radius: 12px;
            padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s ease;
        }
        .file-upload:hover { border-color: var(--accent); background: rgba(233, 69, 96, 0.1); }
        .file-upload.has-file { border-color: var(--success); background: rgba(74, 222, 128, 0.1); }
        .file-upload input { display: none; }
        .file-upload-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .file-upload-text { color: var(--text-secondary); font-size: 0.9rem; }
        .preview-image { max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 10px; display: none; }
        .loading { display: none; text-align: center; padding: 40px; }
        .loading.active { display: block; }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: var(--text-secondary); font-size: 0.95rem; }
        .result { display: none; }
        .result.active { display: block; }
        .recipe-image { width: 100%; height: 200px; object-fit: cover; border-radius: 12px; margin-bottom: 16px; background: rgba(255,255,255,0.1); }
        .recipe-content {
            background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 20px;
            font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap;
            max-height: 600px; overflow-y: auto;
        }
        .recipe-content h1 { font-size: 1.4rem; margin-bottom: 8px; color: var(--accent); }
        .recipe-content h2 { font-size: 1.1rem; margin: 12px 0 6px; color: var(--accent-hover); }
        .recipe-content hr { border: none; border-top: 1px solid rgba(255,255,255,0.15); margin: 10px 0; }
        .hashtag { background: rgba(233, 69, 96, 0.2); color: var(--accent); padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; }
        .settings-toggle {
            position: fixed; top: 20px; right: 20px; width: 44px; height: 44px;
            border-radius: 50%; background: var(--bg-card); border: none;
            color: var(--text-primary); font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3); z-index: 100;
        }
        .settings-panel {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8); z-index: 200; padding: 20px; overflow-y: auto;
        }
        .settings-panel.active { display: flex; align-items: center; justify-content: center; }
        .settings-content { background: var(--bg-card); border-radius: var(--border-radius); padding: 24px; max-width: 500px; width: 100%; }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; }
        .api-status { display: flex; align-items: center; gap: 8px; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 0.9rem; }
        .api-status.connected { background: rgba(74, 222, 128, 0.2); color: var(--success); }
        .api-status.disconnected { background: rgba(233, 69, 96, 0.2); color: var(--accent); }
        .actions { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .error { background: rgba(233, 69, 96, 0.2); border: 1px solid var(--accent); border-radius: 12px; padding: 16px; margin-top: 16px; display: none; }
        .error.active { display: block; }
        .instructions { background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 16px; margin-top: 16px; }
        .instructions h3 { font-size: 1rem; margin-bottom: 12px; }
        .instructions ol { padding-left: 20px; color: var(--text-secondary); font-size: 0.9rem; line-height: 1.8; }
        .instructions a { color: var(--accent); }
        @media (max-width: 400px) {
            body { padding: 15px; }
            .card { padding: 18px; }
            header h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <button class="settings-toggle" onclick="toggleSettings()">&#9881;</button>

    <div class="container">
        <header>
            <h1>Recept Configurator</h1>
            <p>Zet elk recept om naar een ADHD-vriendelijk format</p>
        </header>

        <div class="card" id="inputSection">
            <h2>Recept invoer</h2>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('url')">URL</button>
                <button class="tab" onclick="switchTab('photo')">Foto</button>
                <button class="tab" onclick="switchTab('youtube')">YouTube</button>
            </div>
            <div id="urlTab" class="tab-content active">
                <div class="input-group">
                    <label>Plak een recept URL</label>
                    <input type="url" id="recipeUrl" placeholder="https://www.ah.nl/allerhande/recept/...">
                </div>
            </div>
            <div id="photoTab" class="tab-content">
                <div class="file-upload" id="fileUpload" onclick="document.getElementById('photoInput').click()">
                    <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handleFileSelect(event)">
                    <div class="file-upload-icon">Foto</div>
                    <div class="file-upload-text">Tik om een foto te selecteren<br>of maak een foto van een kookboekpagina</div>
                </div>
                <img id="previewImage" class="preview-image">
            </div>
            <div id="youtubeTab" class="tab-content">
                <div class="input-group">
                    <label>Plak een YouTube URL</label>
                    <input type="url" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=...">
                </div>
            </div>
            <button class="btn btn-primary" id="convertBtn" onclick="convertRecipe()">
                Omzetten naar recept
            </button>
            <div class="error" id="errorMsg"></div>
        </div>

        <div class="loading" id="loadingSection">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Recept wordt geanalyseerd...</div>
        </div>

        <div class="result" id="resultSection">
            <div class="card">
                <h2>Recept klaar!</h2>
                <img id="recipeImage" class="recipe-image" src="" alt="Recept afbeelding">
                <div class="recipe-content" id="recipeContent"></div>
                <div class="actions">
                    <button class="btn btn-success" onclick="openInNotes()">
                        Opslaan in Apple Notities
                    </button>
                    <button class="btn btn-secondary" onclick="copyToClipboard()">
                        Kopieer naar klembord
                    </button>
                    <button class="btn btn-secondary" onclick="resetForm()">
                        Nieuw recept
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-panel" id="settingsPanel">
        <div class="settings-content">
            <div class="settings-header">
                <h2>Instellingen</h2>
                <button class="close-btn" onclick="toggleSettings()">&times;</button>
            </div>
            <div class="api-status disconnected" id="apiStatus">
                <span>Geen API key ingesteld</span>
            </div>
            <div class="input-group">
                <label>Google Gemini API Key</label>
                <input type="password" id="apiKeyInput" placeholder="Voer je API key in...">
            </div>
            <button class="btn btn-primary" onclick="saveApiKey()">Opslaan</button>
            <div class="instructions">
                <h3>Hoe krijg ik een API key?</h3>
                <ol>
                    <li>Ga naar <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a></li>
                    <li>Log in met je Google account</li>
                    <li>Klik op "Create API Key"</li>
                    <li>Kopieer de key en plak hem hierboven</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'url';
        let selectedImage = null;
        let recipeData = null;
        let autoMode = false;

        document.addEventListener('DOMContentLoaded', () => {
            checkApiKey();
            handleUrlParams();
        });

        function handleUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const url = params.get('url');
            const text = params.get('text');
            autoMode = params.get('auto') === 'true';

            if (url) {
                if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    switchTab('youtube');
                    document.getElementById('youtubeUrl').value = url;
                } else {
                    switchTab('url');
                    document.getElementById('recipeUrl').value = url;
                }
                if (localStorage.getItem('gemini_api_key')) {
                    setTimeout(() => convertRecipe(), 500);
                }
            } else if (text) {
                const urlMatch = text.match(/https?:\/\/[^\s]+/);
                if (urlMatch) {
                    const extractedUrl = urlMatch[0];
                    if (extractedUrl.includes('youtube.com') || extractedUrl.includes('youtu.be')) {
                        switchTab('youtube');
                        document.getElementById('youtubeUrl').value = extractedUrl;
                    } else {
                        switchTab('url');
                        document.getElementById('recipeUrl').value = extractedUrl;
                    }
                    if (localStorage.getItem('gemini_api_key')) {
                        setTimeout(() => convertRecipe(), 500);
                    }
                }
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab:nth-child(${tab === 'url' ? 1 : tab === 'photo' ? 2 : 3})`).classList.add('active');
            document.getElementById(`${tab}Tab`).classList.add('active');
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImage = e.target.result;
                    document.getElementById('previewImage').src = selectedImage;
                    document.getElementById('previewImage').style.display = 'block';
                    document.getElementById('fileUpload').classList.add('has-file');
                };
                reader.readAsDataURL(file);
            }
        }

        function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('active'); }

        function checkApiKey() {
            const apiKey = localStorage.getItem('gemini_api_key');
            const statusEl = document.getElementById('apiStatus');
            if (apiKey) {
                statusEl.className = 'api-status connected';
                statusEl.innerHTML = 'API key ingesteld';
                document.getElementById('apiKeyInput').value = '••••••••••••••••';
            } else {
                statusEl.className = 'api-status disconnected';
                statusEl.innerHTML = 'Geen API key ingesteld';
            }
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey && !apiKey.includes('•')) {
                localStorage.setItem('gemini_api_key', apiKey);
                checkApiKey();
                toggleSettings();
                showError('API key opgeslagen!', 'success');
            }
        }

        function showError(message, type = 'error') {
            const errorEl = document.getElementById('errorMsg');
            errorEl.textContent = message;
            errorEl.style.background = type === 'success' ? 'rgba(74, 222, 128, 0.2)' : 'rgba(233, 69, 96, 0.2)';
            errorEl.style.borderColor = type === 'success' ? '#4ade80' : '#e94560';
            errorEl.classList.add('active');
            setTimeout(() => errorEl.classList.remove('active'), 5000);
        }

        async function convertRecipe() {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) { toggleSettings(); showError('Voer eerst je API key in'); return; }

            let input = '';
            let imageData = null;

            if (currentTab === 'url') {
                input = document.getElementById('recipeUrl').value.trim();
                if (!input) { showError('Voer een URL in'); return; }
            } else if (currentTab === 'youtube') {
                input = document.getElementById('youtubeUrl').value.trim();
                if (!input) { showError('Voer een YouTube URL in'); return; }
            } else if (currentTab === 'photo') {
                if (!selectedImage) { showError('Selecteer eerst een foto'); return; }
                imageData = selectedImage;
            }

            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('loadingSection').classList.add('active');
            document.getElementById('resultSection').classList.remove('active');

            try {
                const result = await callGeminiAPI(apiKey, input, imageData);
                displayResult(result);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('inputSection').style.display = 'block';
                document.getElementById('loadingSection').classList.remove('active');
                showError('Er ging iets mis: ' + error.message);
            }
        }

        async function fetchUrlContent(url) {
            const proxies = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                `https://corsproxy.io/?${encodeURIComponent(url)}`
            ];
            for (const proxyUrl of proxies) {
                try {
                    const response = await fetch(proxyUrl);
                    if (response.ok) {
                        const html = await response.text();
                        const doc = new DOMParser().parseFromString(html, 'text/html');
                        doc.querySelectorAll('script, style, nav, footer, aside').forEach(el => el.remove());

                        const recipeSelectors = ['[itemtype*="Recipe"]', '.recipe', '#recipe', 'article', 'main', '.content'];
                        let content = '';
                        for (const selector of recipeSelectors) {
                            const el = doc.querySelector(selector);
                            if (el && el.textContent.length > 200) { content = el.textContent; break; }
                        }
                        if (!content) content = doc.body?.textContent || '';
                        content = content.replace(/\s+/g, ' ').trim().substring(0, 15000);

                        let imageUrl = null;
                        const ogImage = doc.querySelector('meta[property="og:image"]');
                        if (ogImage) imageUrl = ogImage.getAttribute('content');
                        if (!imageUrl) {
                            const recipeImg = doc.querySelector('[itemtype*="Recipe"] img, .recipe img, article img, main img');
                            if (recipeImg) imageUrl = recipeImg.getAttribute('src') || recipeImg.getAttribute('data-src');
                        }

                        return { content, imageUrl, title: doc.title };
                    }
                } catch (e) { continue; }
            }
            throw new Error('Kon de pagina niet ophalen.');
        }

        async function fetchYouTubeTranscript(videoId) {
            // Try to get more info from YouTube page including description with timestamps
            try {
                const ytData = await fetchUrlContent(`https://www.youtube.com/watch?v=${videoId}`);
                return ytData;
            } catch (e) {
                return null;
            }
        }

        function getYouTubeVideoId(url) {
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
                /youtube\.com\/shorts\/([^&\n?#]+)/
            ];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        async function callGeminiAPI(apiKey, input, imageData) {
            const models = ['gemini-2.0-flash', 'gemini-2.0-flash-lite', 'gemini-1.5-flash'];

            const prompt = `Je bent een recept-assistent die recepten omzet naar een compact, ADHD-vriendelijk format in het Nederlands. Het recept moet er netjes en overzichtelijk uitzien in Apple Notes.

BELANGRIJKE REGELS:
1. BEHOUD HET ORIGINELE RECEPT ZO VEEL MOGELIJK - verander geen ingredienten, hoeveelheden of stappen tenzij nodig voor de conversie naar 4 personen
2. Alle hoeveelheden MOETEN voor 4 personen zijn (reken proportioneel om indien nodig)
3. Alle maten in Nederlands (geen cups maar ml, geen oz maar gram, geen inches maar cm, geen Fahrenheit maar Celsius, geen sticks butter maar gram boter, geen tbsp maar el, geen tsp maar tl)
4. Als het recept in het Engels of een andere taal is: VERTAAL ALLES naar het Nederlands, inclusief ingredientnamen, instructies en beschrijvingen
5. Duidelijke, korte zinnen - maar behoud de originele instructies
6. Voeg NIETS toe dat niet in het origineel staat
7. GEEN emoji's gebruiken, nergens in het recept
8. Compacte opmaak: geen onnodige lege regels of grote gaten
9. Als tijden per stap niet exact bekend zijn, maak dan een realistische inschatting op basis van de beschreven handelingen (bijv. uien fruiten = ca. 5 min, water aan de kook = ca. 8 min, etc.)

GEEF HET RECEPT IN DIT EXACTE FORMAT (let op: GEEN emoji's):

# [Receptnaam]

Tijden: Voorbereiding [X] min | Bereiden [X] min | Totaal [X] min
Porties: 4 personen

---

INGREDIENTEN
- [hoeveelheid] [ingredient]
- [hoeveelheid] [ingredient]

BENODIGDHEDEN
- [keukengerei]
- [keukengerei]

---

STAPPENPLAN

STAP 1 - [Fase naam] ([X] min)
- [Actie]
- [Actie]

STAP 2 - [Fase naam] ([X] min)
- [Actie]
- [Actie]

---

Tags: #[categorie] #[categorie] #[categorie]

Bron: [URL of "Kookboek foto"]
Porties aanpassen: https://cooked.wiki/

MOGELIJKE TAGS: #ontbijt #lunch #diner #snack #dessert #vega #veganistisch #vis #vlees #kip #pasta #rijst #aardappel #soep #salade #glutenvrij #zuivelvrij #comfort #gezond #snel #weekmenu`;

            let requestBody;
            let fetchedImageUrl = null;

            if (imageData) {
                const base64Data = imageData.split(',')[1];
                const mimeType = imageData.split(';')[0].split(':')[1];
                requestBody = {
                    contents: [{
                        parts: [
                            { text: prompt + '\n\nAnalyseer deze foto van een recept en geef het recept in het gevraagde format.\nBRON: Kookboek foto\nBehoud het recept exact zoals het in de foto staat, alleen het format aanpassen en omrekenen naar 4 personen.' },
                            { inline_data: { mime_type: mimeType, data: base64Data } }
                        ]
                    }]
                };
            } else if (input.includes('youtube.com') || input.includes('youtu.be')) {
                document.getElementById('loadingText').textContent = 'YouTube video wordt geanalyseerd...';
                const videoId = getYouTubeVideoId(input);
                if (!videoId) throw new Error('Ongeldige YouTube URL');

                fetchedImageUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;

                document.getElementById('loadingText').textContent = 'Video informatie ophalen...';
                const ytData = await fetchYouTubeTranscript(videoId);

                if (ytData) {
                    requestBody = {
                        contents: [{
                            parts: [{
                                text: prompt + `\n\nDit is informatie van een YouTube kookvideo. Extraheer het recept uit deze informatie.

BRON URL: ${input}
Titel: ${ytData.title}

Beschrijving en content van de video pagina:
${ytData.content}

BELANGRIJKE INSTRUCTIES VOOR YOUTUBE:
- Analyseer de beschrijving en eventuele timestamps zorgvuldig
- Als exacte tijden niet vermeld worden, maak dan realistische inschattingen:
  * Groenten snijden: 5-10 min
  * Iets aanbakken/fruiten: 3-5 min
  * Saus maken: 5-10 min
  * Pasta koken: 8-12 min
  * Vlees bakken: varies per dikte
  * Oven: kijk naar temperatuur indicaties
- Behoud het recept zo origineel mogelijk, voeg niets toe
- Als ingredienten in de beschrijving staan, gebruik die exact`
                            }]
                        }]
                    };
                } else {
                    requestBody = {
                        contents: [{
                            parts: [{
                                text: prompt + `\n\nDit is een YouTube kookvideo URL: ${input}\nBRON URL: ${input}\nGeef een basis recept format terug. Zet [INVULLEN] waar informatie ontbreekt.`
                            }]
                        }]
                    };
                }
            } else {
                document.getElementById('loadingText').textContent = 'Recept wordt opgehaald...';
                const pageData = await fetchUrlContent(input);
                fetchedImageUrl = pageData.imageUrl;
                requestBody = {
                    contents: [{
                        parts: [{
                            text: prompt + `\n\nHieronder staat de inhoud van een receptpagina. Extraheer het recept en zet het om naar het gevraagde format.\nBRON URL: ${input}\nBehoud het recept zo origineel mogelijk - verander alleen het format en reken om naar 4 personen.\n\n---\n${pageData.content}\n---`
                        }]
                    }]
                };
            }

            document.getElementById('loadingText').textContent = 'Recept wordt geanalyseerd met AI...';

            let lastError = null;
            for (const model of models) {
                const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
                try {
                    document.getElementById('loadingText').textContent = `Recept analyseren...`;
                    const response = await fetch(`${endpoint}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorMsg = errorData.error?.message || 'API request failed';
                        if (response.status === 429 || errorMsg.includes('quota') || errorMsg.includes('rate')) {
                            lastError = new Error(errorMsg);
                            continue;
                        }
                        throw new Error(errorMsg);
                    }

                    const data = await response.json();
                    const text = data.candidates[0]?.content?.parts[0]?.text;
                    if (!text) throw new Error('Geen recept ontvangen van AI');

                    // Try to extract image URL from AI response if we don't have one
                    if (!fetchedImageUrl) {
                        const imgMatch = text.match(/https?:\/\/[^\s]+\.(?:jpg|jpeg|png|webp)/i);
                        if (imgMatch) fetchedImageUrl = imgMatch[0];
                    }

                    return { recipe: text.trim(), imageUrl: fetchedImageUrl };
                } catch (e) {
                    lastError = e;
                    if (e.message.includes('quota') || e.message.includes('rate') || e.message.includes('429')) continue;
                    throw e;
                }
            }

            throw new Error(
                'Alle AI modellen zijn op dit moment niet beschikbaar.\n\n' +
                'Oplossing: Maak een nieuwe API key aan:\n' +
                '1. Ga naar aistudio.google.com/apikey\n' +
                '2. Klik "Create API Key in new project"\n' +
                '3. Plak de nieuwe key in de instellingen'
            );
        }

        function displayResult(result) {
            document.getElementById('loadingSection').classList.remove('active');
            document.getElementById('resultSection').classList.add('active');
            recipeData = result;

            const imageEl = document.getElementById('recipeImage');
            if (result.imageUrl) {
                imageEl.src = result.imageUrl;
                imageEl.style.display = 'block';
                imageEl.onerror = () => { imageEl.style.display = 'none'; };
            } else if (selectedImage) {
                imageEl.src = selectedImage;
                imageEl.style.display = 'block';
            } else {
                imageEl.style.display = 'none';
            }

            document.getElementById('recipeContent').innerHTML = formatRecipeHTML(result.recipe);

            if (autoMode) {
                // On iOS auto-mode doesn't work well with clipboard, show the save button prominently instead
                document.querySelector('.btn-success').style.fontSize = '1.2rem';
                document.querySelector('.btn-success').style.padding = '20px';
            }
        }

        function formatRecipeHTML(text) {
            return text
                .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/^- (.+)$/gm, '&bull; $1')
                .replace(/^---$/gm, '<hr>')
                .replace(/(#\w+)/g, '<span class="hashtag">$1</span>')
                .replace(/^(INGREDIENTEN|BENODIGDHEDEN|STAPPENPLAN)$/gm, '<h2>$1</h2>')
                .replace(/^(STAP \d+ - .+)$/gm, '<strong>$1</strong>')
                .replace(/\n{3,}/g, '\n\n');
        }

        function openInNotes() {
            if (!recipeData) return;

            const plainText = recipeData.recipe
                .replace(/\*\*/g, '')
                .replace(/^#{1,2}\s*/gm, '')
                .replace(/---/g, '---')
                .replace(/\n{3,}/g, '\n\n');

            // Copy to clipboard using both methods for iOS compatibility
            const textarea = document.createElement('textarea');
            textarea.value = plainText;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();

            try {
                document.execCommand('copy');
            } catch (e) {}

            // Also try modern API
            navigator.clipboard.writeText(plainText).catch(() => {});

            document.body.removeChild(textarea);

            // Try to open Shortcut
            window.location.href = 'shortcuts://run-shortcut?name=Recept%20Opslaan';

            setTimeout(() => {
                showError('Recept gekopieerd naar klembord en Shortcut gestart!', 'success');
            }, 500);
        }

        function copyToClipboard() {
            if (!recipeData) return;
            const plainText = recipeData.recipe
                .replace(/\*\*/g, '')
                .replace(/^#{1,2}\s*/gm, '')
                .replace(/\n{3,}/g, '\n\n');

            const textarea = document.createElement('textarea');
            textarea.value = plainText;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try { document.execCommand('copy'); } catch (e) {}
            navigator.clipboard.writeText(plainText).catch(() => {});
            document.body.removeChild(textarea);
            showError('Gekopieerd naar klembord!', 'success');
        }

        function resetForm() {
            document.getElementById('inputSection').style.display = 'block';
            document.getElementById('resultSection').classList.remove('active');
            document.getElementById('recipeUrl').value = '';
            document.getElementById('youtubeUrl').value = '';
            document.getElementById('previewImage').style.display = 'none';
            document.getElementById('fileUpload').classList.remove('has-file');
            selectedImage = null;
            recipeData = null;
        }
    </script>
</body>
</html>
